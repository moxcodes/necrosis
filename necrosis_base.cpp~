#include "SDL2/SDL.h"
#include "SDL2/SDL_image.h"
#include "SDL2/SDL_ttf.h"
#include <string>
#include <stdio.h>
#include <vector>

int SCREEN_WIDTH = 800;
int SCREEN_HEIGHT = 600;
int SCREEN_BPP = 32;

SDL_Surface* image = NULL;
SDL_Surface* screen = NULL;

SDL_Window* gWindow = NULL;
SDL_Renderer* gRenderer = NULL;
SDL_Texture* gTexture = NULL;


/////Cursor and map stuff:
SDL_Rect cursorRect;

bool cursorDeactivate=false;
int cursorCooldown=0;

int protomap[5][5] =
  {{1,1,1,1,1},
   {1,1,1,1,1},
   {1,1,1,1,0},
   {1,1,1,1,1},
   {1,1,1,1,1}};

int cursorCoords[2] = {0,0};
/////

////Player stuff
int maxPlayerMovement=1;
std::vector<std::vector<int> > playerMoveOptions;
SDL_Texture* playerTexture;
int playerCoords[2] = {2,4};


SDL_Texture* load_texture(std::string filename);

void computeMoveOptions(int[2] coords,int maxMovement,std::vector<std::vector<int> >* moveOptions);

SDL_Texture* load_texture(std::string filename)
{
  SDL_Texture* newTexture = NULL;

  SDL_Surface* loadedSurface = IMG_Load( filename.c_str() );
  if( loadedSurface == NULL)
    {
      printf( "oopsidaisies! %s didn't load! SDL error: %s\n",filename.c_str(), IMG_GetError());
      return NULL;
    }
  newTexture = SDL_CreateTextureFromSurface( gRenderer, loadedSurface );
  if( newTexture == NULL )
    printf("balls balls balls %s\n",SDL_GetError() );
  SDL_FreeSurface(loadedSurface);
  return newTexture;
}

void handle_keys(SDL_Event* event, bool* quit)
{
  bool noKeyDown=true;
  if(event->type == SDL_KEYDOWN)
    {
      switch( event->key.keysym.sym )
	{
	case SDLK_ESCAPE:
	  *quit = true;
	case SDLK_LEFT:
	  noKeyDown=false;
	  if(cursorCoords[0]-1 >=0 && protomap[cursorCoords[1]][cursorCoords[0]-1]==1
	     &&!cursorDeactivate)
	    {
	      cursorCoords[0]=cursorCoords[0]-1;
	      cursorDeactivate=true;
	      cursorCooldown=SDL_GetTicks()+150;
	    }
	  break;
	case SDLK_RIGHT:
	  noKeyDown=false;
	  if(cursorCoords[0]+1 <5 && protomap[cursorCoords[1]][cursorCoords[0]+1]==1
	     &&!cursorDeactivate)
	    {
	      cursorCoords[0]=cursorCoords[0]+1;
	      cursorDeactivate=true;
	      cursorCooldown=SDL_GetTicks()+150;
	    }
	  break;
	case SDLK_UP:
	  noKeyDown=false;
	  if(cursorCoords[1]-1 >=0 && protomap[cursorCoords[1]-1][cursorCoords[0]]==1
	     &&!cursorDeactivate)
	    {
	      cursorCoords[1]=cursorCoords[1]-1;
	      cursorDeactivate=true;
	      cursorCooldown=SDL_GetTicks()+150;
	    }
	  break;
	case SDLK_DOWN:
	  noKeyDown=false;
	  if(cursorCoords[1]+1 <5 && protomap[cursorCoords[1]+1][cursorCoords[0]]==1
	     &&!cursorDeactivate)
	    {
	      cursorCoords[1]=cursorCoords[1]+1;
	      cursorDeactivate=true;
	      cursorCooldown=SDL_GetTicks()+150;
	    }
	  break;
	}
      if(noKeyDown){
	cursorCooldown=0;
	cursorDeactivate=false;
      }
    }	
  return;
}

void computeMoveOptions(int[2] coords,int maxMovement,std::vector<std::vector<int> >* moveOptions)
{
   for()
   {
       for()
       {
       }
   }
   return;
}

int main (int argc, char* args[])
{
  //main setup phase
  TTF_Init();
  SDL_Init( SDL_INIT_EVERYTHING );
  gWindow = SDL_CreateWindow( "necrosis", SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED, SCREEN_WIDTH, SCREEN_HEIGHT, SDL_WINDOW_SHOWN );
  if( gWindow == NULL)
    {
      printf("well. Fuck. Sorry boys");
      return -1;
    }

  gRenderer = SDL_CreateRenderer( gWindow, -1, SDL_RENDERER_ACCELERATED );

  if( gRenderer == NULL )
    {
      printf("okay, no hardware acceleration. This one is on you, pal.");
      return -1;
    }

  SDL_SetRenderDrawColor(gRenderer,0xFF,0xFF,0xFF,0xFF );
  int imgFlags = IMG_INIT_PNG;
  IMG_Init( imgFlags );


  SDL_Texture* gridTexture = load_texture( "img/necrosis_prototype_bg.png" );
  SDL_Texture* selectTexture = load_texture( "img/necrosis_prototype_select.png" );

  playerTexture = load_texture( "img/player_coin.png" );
  cursorRect.w=146;
  cursorRect.h=85;
  cursorRect.x=37;
  cursorRect.y=119;
  
  //  image = load_image("image.jpg");
  TTF_Font* Sans = TTF_OpenFont("fonts/Inconsolata-Bold.ttf",24);
  SDL_Color White = {255,255,255};
  SDL_Surface* turnSurface; 
  SDL_Texture* turnTexture;
  SDL_Rect turnRect;
  turnRect.x=20;
  turnRect.y=500;
  SDL_Rect playerRect;
  playerRect.w=90;
  playerRect.h=60;
  int turn=0;
  
  bool quit = false;

  SDL_Event event;
  // The main loop - this will go until the game is shutting down.
  while(!quit)
    {
      while( SDL_PollEvent( &event ) != 0 )
	{
	  if( event.type == SDL_QUIT )
	    {
	      quit = true;
	    }
	}
      std::string text="turn " + std::to_string(turn);
      
      turnSurface = TTF_RenderText_Solid(Sans,text.c_str(),White);
      turnRect.w=turnSurface->w;
      turnRect.h=turnSurface->h;
      turnTexture = SDL_CreateTextureFromSurface(gRenderer, turnSurface);

      //      SDL_FreeSurface(turnSurface);
      computeMoveOptions(playerCoords,maxPlayerMovement,&playerMoveOptions)
      handle_keys(&event,&quit);
      if(cursorCooldown<SDL_GetTicks())
	cursorDeactivate=false;
      cursorRect.x=cursorCoords[0]*100.5+37 + cursorCoords[1]*54.5;
      cursorRect.y=cursorCoords[1]*54.5+119;
      playerRect.x=playerCoords[0]*100.5+65 + playerCoords[1]*54.5;
      playerRect.y=playerCoords[1]*54.5+125;
      SDL_RenderClear( gRenderer );
      SDL_RenderCopy( gRenderer, gridTexture, NULL, NULL );
      SDL_RenderCopy( gRenderer, selectTexture, NULL, &cursorRect );
      SDL_RenderCopy( gRenderer, turnTexture, NULL, &turnRect );
      SDL_RenderCopy( gRenderer, playerTexture, NULL, &playerRect );
      SDL_RenderPresent( gRenderer );
      //      SDL_DestroyTexture(turnTexture);
    }


  SDL_DestroyTexture( gTexture );
  SDL_DestroyTexture( gridTexture );
  SDL_DestroyTexture( selectTexture );
  SDL_DestroyRenderer( gRenderer );
  SDL_DestroyWindow( gWindow );
  gWindow = NULL;
  gRenderer = NULL;
  IMG_Quit();
  SDL_Quit();

  return 0;
}
